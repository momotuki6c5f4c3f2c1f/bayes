<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ジャグラー設定推定＆期待値計算ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f7;
      color: #222;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 1.5rem;
      margin-bottom: 0.3rem;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background: #f0f0f5;
    }
    input[type="number"] {
      width: 100%;
      box-sizing: border-box;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.85rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }
    .btn {
      display: inline-block;
      margin-top: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      background: #0070f3;
      color: #fff;
    }
    .btn:active {
      transform: translateY(1px);
    }
    .result {
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .error {
      color: #d00;
      font-size: 0.85rem;
      margin-top: 4px;
    }
    .muted {
      font-size: 0.8rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>ジャグラー設定推定＆期待値計算ツール（ベイズ版）</h1>
  <p class="muted">
    各設定のボーナス確率・機械割と、ホールの投入率（事前分布）を入れて、実戦データから設定の“それっぽさ”と期待値を計算します。
    <br>※数値は自分で調べて入力してください。
  </p>

  <!-- スペック入力 -->
  <div class="card">
    <h2>1. 台のスペック（各設定のボーナス確率・機械割）</h2>
    <p class="muted">BIG/REG確率は「1/x」の x を入力。機械割は％。</p>
    <table>
      <thead>
        <tr>
          <th>設定</th>
          <th>BIG確率 (1/x)</th>
          <th>REG確率 (1/x)</th>
          <th>機械割 (%)</th>
          <th>事前重み<br>(投入率の比)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td><input type="number" step="0.1" id="big_1over_1" placeholder="例: 287.4"></td>
          <td><input type="number" step="0.1" id="reg_1over_1" placeholder="例: 431.2"></td>
          <td><input type="number" step="0.1" id="rtp_1" placeholder="例: 97.0"></td>
          <td><input type="number" step="0.1" id="prior_1" placeholder="例: 50"></td>
        </tr>
        <tr>
          <td>2</td>
          <td><input type="number" step="0.1" id="big_1over_2"></td>
          <td><input type="number" step="0.1" id="reg_1over_2"></td>
          <td><input type="number" step="0.1" id="rtp_2"></td>
          <td><input type="number" step="0.1" id="prior_2" placeholder="例: 30"></td>
        </tr>
        <tr>
          <td>3</td>
          <td><input type="number" step="0.1" id="big_1over_3"></td>
          <td><input type="number" step="0.1" id="reg_1over_3"></td>
          <td><input type="number" step="0.1" id="rtp_3"></td>
          <td><input type="number" step="0.1" id="prior_3" placeholder="例: 10"></td>
        </tr>
        <tr>
          <td>4</td>
          <td><input type="number" step="0.1" id="big_1over_4"></td>
          <td><input type="number" step="0.1" id="reg_1over_4"></td>
          <td><input type="number" step="0.1" id="rtp_4"></td>
          <td><input type="number" step="0.1" id="prior_4" placeholder="例: 5"></td>
        </tr>
        <tr>
          <td>5</td>
          <td><input type="number" step="0.1" id="big_1over_5"></td>
          <td><input type="number" step="0.1" id="reg_1over_5"></td>
          <td><input type="number" step="0.1" id="rtp_5"></td>
          <td><input type="number" step="0.1" id="prior_5" placeholder="例: 3"></td>
        </tr>
        <tr>
          <td>6</td>
          <td><input type="number" step="0.1" id="big_1over_6"></td>
          <td><input type="number" step="0.1" id="reg_1over_6"></td>
          <td><input type="number" step="0.1" id="rtp_6"></td>
          <td><input type="number" step="0.1" id="prior_6" placeholder="例: 2"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 実戦データ -->
  <div class="card">
    <h2>2. 実戦データ</h2>
    <div class="grid">
      <div>
        <label>総ゲーム数 G</label>
        <input type="number" id="games" placeholder="例: 3000">
      </div>
      <div>
        <label>BIG回数 B</label>
        <input type="number" id="big_count" placeholder="例: 12">
      </div>
      <div>
        <label>REG回数 R</label>
        <input type="number" id="reg_count" placeholder="例: 10">
      </div>
      <div>
        <label>計算用ベット金額（円）</label>
        <input type="number" id="bet_amount" value="1000">
        <span class="muted">※EVを「◯円あたり」で出す用。デフォルト1000円。</span>
      </div>
    </div>
    <button class="btn" onclick="runCalc()">計算する</button>
    <div id="error" class="error"></div>
  </div>

  <!-- 結果表示 -->
  <div class="card">
    <h2>3. 結果</h2>
    <div id="result" class="result">
      入力後、「計算する」を押してください。
    </div>
  </div>

  <script>
    function runCalc() {
      const errEl = document.getElementById("error");
      const resEl = document.getElementById("result");
      errEl.textContent = "";
      resEl.textContent = "";

      const G = Number(document.getElementById("games").value);
      const B = Number(document.getElementById("big_count").value);
      const R = Number(document.getElementById("reg_count").value);
      const bet = Number(document.getElementById("bet_amount").value);

      if (!G || G <= 0) {
        errEl.textContent = "総ゲーム数 G を正しく入力してください。";
        return;
      }
      if (B < 0 || R < 0 || B + R > G) {
        errEl.textContent = "BIG/REGの回数が総ゲーム数と矛盾しています。";
        return;
      }
      if (!bet || bet <= 0) {
        errEl.textContent = "ベット金額を正しく入力してください。";
        return;
      }

      const K = 6;
      const pB = [];
      const pR = [];
      const rtp = [];
      const priorRaw = [];

      for (let k = 1; k <= K; k++) {
        const big1over = Number(document.getElementById("big_1over_" + k).value);
        const reg1over = Number(document.getElementById("reg_1over_" + k).value);
        const rtpVal   = Number(document.getElementById("rtp_" + k).value);
        const priorVal = Number(document.getElementById("prior_" + k).value);

        if (!big1over || !reg1over || !rtpVal) {
          errEl.textContent = "設定" + k + " のスペック（BIG/REG確率・機械割）をすべて入力してください。";
          return;
        }
        const pB_k = 1.0 / big1over;
        const pR_k = 1.0 / reg1over;
        const sumBonus = pB_k + pR_k;
        if (sumBonus <= 0 || sumBonus >= 1) {
          errEl.textContent = "設定" + k + " のBIG+REG確率が異常です（合計が0〜1の間になるようにしてください）。";
          return;
        }
        pB[k] = pB_k;
        pR[k] = pR_k;
        rtp[k] = rtpVal / 100.0; // 小数に変換
        priorRaw[k] = priorVal > 0 ? priorVal : 0;
      }

      const priorSum = priorRaw.reduce((acc, v) => acc + (v || 0), 0);
      if (priorSum <= 0) {
        errEl.textContent = "事前重み（投入率の比）がすべて0です。少なくとも1つは正の値を入れてください。";
        return;
      }

      // 正規化した事前分布
      const prior = [];
      for (let k = 1; k <= K; k++) {
        prior[k] = priorRaw[k] / priorSum;
      }

      // ログ尤度計算
      const logL = [];
      let maxLogL = -Infinity;
      for (let k = 1; k <= K; k++) {
        const pBk = pB[k];
        const pRk = pR[k];
        const pNone = 1.0 - pBk - pRk;

        const eps = 1e-15; // log(0)回避用
        const logTerm =
          B * Math.log(pBk + eps) +
          R * Math.log(pRk + eps) +
          (G - B - R) * Math.log(pNone + eps);

        logL[k] = logTerm;
        if (logTerm > maxLogL) maxLogL = logTerm;
      }

      // 事後分布（未正規化）
      const unnorm = [];
      let sumUnnorm = 0;
      for (let k = 1; k <= K; k++) {
        const val = prior[k] * Math.exp(logL[k] - maxLogL); // 数値安定化
        unnorm[k] = val;
        sumUnnorm += val;
      }

      if (!(sumUnnorm > 0)) {
        errEl.textContent = "計算中に数値エラーが発生しました（入力値を見直してください）。";
        return;
      }

      // 正規化された事後分布
      const post = [];
      for (let k = 1; k <= K; k++) {
        post[k] = unnorm[k] / sumUnnorm;
      }

      // 事後分布で重み付けした機械割
      let rMix = 0;
      for (let k = 1; k <= K; k++) {
        rMix += post[k] * rtp[k];
      }
      const evPerBet = bet * (rMix - 1.0);

      // 表示用HTML生成
      let html = "";
      html += "<p>ベット " + bet.toLocaleString() + " 円あたりの結果：</p>";
      html += "<ul>";
      html += "<li>事後分布で重み付けした想定機械割： <b>" + (rMix*100).toFixed(2) + " %</b></li>";
      html += "<li>" + bet.toLocaleString() + " 円あたりの期待収支： <b>" + evPerBet.toFixed(1) + " 円</b></li>";
      html += "</ul>";

      html += "<h3>設定ごとの事前・事後の比較</h3>";
      html += "<table><thead><tr>" +
              "<th>設定</th>" +
              "<th>事前分布 (%)</th>" +
              "<th>事後分布 (%)</th>" +
              "<th>機械割 (%)</th>" +
              "</tr></thead><tbody>";
      for (let k = 1; k <= K; k++) {
        html += "<tr>" +
          "<td>" + k + "</td>" +
          "<td>" + (prior[k]*100).toFixed(1) + "</td>" +
          "<td>" + (post[k]*100).toFixed(1) + "</td>" +
          "<td>" + (rtp[k]*100).toFixed(1) + "</td>" +
        "</tr>";
      }
      html += "</tbody></table>";
      html += '<p class="muted">※事前分布は入力した「事前重み」を正規化したものです。</p>';

      resEl.innerHTML = html;
    }
  </script>
</body>
</html>
